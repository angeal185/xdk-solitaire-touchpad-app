function p(t){this.cards=t?t.cards:[]}function r(){}function t(t){if(0==t.stock.length())for(;t.waste.length();){var e=t.waste.pop();t.stock.add(e)}else for(var n=0;n!=t.rules.cardsToDraw&&t.stock.length();n++)e=t.stock.pop(),t.waste.add(e)}function u(t){var e=t%13;return 0==e?[]:2>Math.floor(t/13)?[26+(e-1),39+(e-1)]:[0+(e-1),13+(e-1)]}function v(t){var e=t%13;return 12==e?[]:[13*Math.floor(t/13)+(e+1)]}function w(t,e,n){for(;e;){var o;t:{o=t;for(var a=e,i=0;7!=i;i++){var s=o.tableausFaceUp[i],r=s.indexOf(a);if(-1!=r&&r<s.length()-1){o=s.get(r+1);break t}}o=null}t.remove(e)&&t.tableausFaceUp[n].add(e),e=o}}function x(t,e,n){var o=document.createElement("span");o.style.width=t.g+"px",o.style.height=t.f+"px",o.className="placeholder",o.style.backgroundPosition="-"+t.g*t.Q+"px -"+t.f*t.v+"px",o.style.left=e+"px",o.style.top=n+"px",t.F.appendChild(o)}function z(t,e,n){var o=document.createElement("span");return o.style.width=t.g+"px",o.style.height=t.f+"px",o.className="overlay",o.style.left=e+"px",o.style.top=n+"px",t.D.appendChild(o),o}function A(t){var e=document.createElement("span");return e.style.width=t.g+"px",e.style.height=t.f+"px",e.className="card",B(t,e),e}function D(t){var e=document.createElement("span");return e.className="indicator",e.style.width=t.N+"px",e.style.height=t.K+"px",e.style.backgroundPosition="-"+t.O+"px -"+t.P+"px",e}function B(t,e){e.style.backgroundPosition=t.g*t.I+"px -"+t.f*t.v+"px"}function E(t,e,n){e.style.backgroundPosition="-"+t.g*(n%13)+"px -"+t.f*Math.floor(n/13)+"px"}function F(t,e,n,o,a){t.o.hasOwnProperty(e)||(t.o[e]={}),t.o[e][n+"/"+o]=(new Date).getTime();var i=t.a[e];if(G(t,i,null,null),Math.round(i.offsetLeft)==Math.round(n)&&Math.round(i.offsetTop)==Math.round(o))i.style.B="none",i.style.zIndex=0,a();else{i.style.zIndex=1;var s=(new Date).getTime();t.d[e]={startTime:s,U:s+t.J,G:i.offsetLeft,H:i.offsetTop,r:n,s:o,Z:a}}}function J(t,e,n,o){for(t.V=o.clientX,t.W=o.clientY,o=0;52!=o;o++){var a=t.a[o];a.onmousemove=null,a.onclick=null}t.c.style.display="none",t.C=!0,document.onmousemove=function(n){if(t.C)for(k in t.C=!1,e){var o=t.a[e[k]];o.style.zIndex=1,o.style.B="rgba(0, 0, 0, 0.497656) -3px -3px 12px inset, rgba(0, 0, 0, 0.398438) 4px 5px 5px"}else for(k in e)o=t.a[e[k]],o.style.left=o.offsetLeft+n.clientX-t.X+"px",o.style.top=o.offsetTop+n.clientY-t.Y+"px";t.X=n.clientX,t.Y=n.clientY},document.onmouseup=function(o){var a=t.V==o.clientX&&t.W==o.clientY,i=e[0],s=t.a[i];if(o=t.b[i]){if(a){var r=Number.MAX_VALUE,l=[];for(k in o)if(a=o[k],1==e.length||a.e){var c=t.o[i][a.x+"/"+a.y];c||(c=Number.MIN_VALUE),c==r?l.push(a):r>c&&(r=c,l=[a])}l&&(o=l),i=Number.MIN_VALUE,r=[];for(k in o)a=o[k],(1==e.length||a.e)&&(l=a.q,l==i?r.push(a):l>i&&(i=l,r=[a]));r&&(o=r)}i=s.offsetLeft,s=s.offsetTop,r=Number.MAX_VALUE;for(k in o)a=o[k],(1==e.length||a.e)&&(l=Math.pow(i-a.x,2)+Math.pow(s-a.y,2),r>l&&(r=l,closestSlot=a));closestSlot&&closestSlot.action()}document.onmousemove=null,document.onmouseup=null,K(n),L(t,n)}}function G(t,e,n,o){o||n?e.onmousemove=function(){t.c.style.left=e.offsetLeft+t.L+"px",t.c.style.top=e.offsetTop+t.M+"px",e.parentNode.insertBefore(t.c,e.nextSibling),t.c.style.display="block",t.c.onmousedown=n,e.onmousedown=n,t.c.onclick=o,e.onclick=o,t.c.onmouseout=function(){t.c.style.display="none"}}:(e.onclick=null,e.onmousemove=null,e.onmousedown=null)}function M(t,e){t.p.removeChild(e),t.p.appendChild(e)}function N(t,e){t.style.B="none",t.style.zIndex=0,e.Z()}function L(e,n){e.b={};for(k in e.d){var o=e.d[k],a=e.a[k];a.style.left=o.r+"px",a.style.top=o.s+"px",N(a,o),delete e.d[k]}for(var i=0;4!=i;i++){var s=n.foundations[i],r=e.w+e.A*i,l=s.length();if(0==l){var c=[0,13,26,39];for(k in c){var f=c[k],h=e.b[f];null==h&&(h=[]),new function(t,o,a){h.push({x:a,y:e.l,action:function(){n.remove(t)&&n.foundations[o].add(t)},q:3,e:!1})}(f,i,r),e.b[f]=h}}else for(var p=0;l>p;p++){var d,o=s.get(p),a=e.a[o];if(p==l-1){var g=[o];!new function(t,o,a){d=function(){E(e,o,a),G(e,o,function(o){J(e,t,n,o)})}}(g,a,o),c=v(o);for(k in c)f=c[k],h=e.b[f],null==h&&(h=[]),new function(t,o){h.push({x:r,y:e.l,action:function(){n.remove(t)&&n.foundations[o].add(t)},q:3,e:!1})}(f,i),e.b[f]=h}else d=function(){};F(e,o,r,e.l,d),M(e,a)}}for(i=0;7!=i;i++){for(s=n.tableausFaceDown[i],l=s.length(),p=0;l>p;p++)o=s.get(p),a=e.a[o],F(e,o,e.i+e.j*i,e.k+e.n*p,function(){}),B(e,a),M(e,a);var s=n.tableausFaceUp[i],m=s.length();if(0==m)for(k in c=[12,25,38,51])f=c[k],h=e.b[f],null==h&&(h=[]),new function(t,o){h.push({x:e.i+e.j*o,y:e.k+0*e.n,action:function(){w(n,t,o)},q:2,e:!0})}(f,i,p),e.b[f]=h;else for(p=0;m>p;p++){if(o=s.get(p),a=e.a[o],g=s.cards.slice(p),p==m-1)for(k in c=u(o))f=c[k],h=e.b[f],null==h&&(h=[]),new function(t,o,a,i){h.push({x:e.i+e.j*o,y:e.k+e.n*(a+i+1),action:function(){w(n,t,o)},q:2,e:!0})}(f,i,p,l),e.b[f]=h;!new function(t,o,a){d=function(){E(e,o,a),G(e,o,function(o){J(e,t,n,o)})}}(g,a,o),F(e,o,e.i+e.j*i,e.k+e.n*(p+l),d),M(e,a)}}for(var c=n.stock.length(),y=0;y!=c;y++)o=n.stock.get(y),a=e.a[o],B(e,a),M(e,a),F(e,o,e.m,e.h,function(){});G(e,e.$,null,function(){t(n),K(n),L(e,n)});for(var x=n.waste.length(),y=0;y!=x;y++)new function(){var t,o=n.waste.get(y),a=e.a[o];if(y==x-1){var i=[];i.push(o),t=function(){G(e,a,function(t){J(e,i,n,t)},null),E(e,a,o)}}else t=function(){E(e,a,o)};M(e,a);var s=y-(x-Math.min(n.rules.cardsToDraw,x));0>s&&(s=0),F(e,o,e.R+e.S*s,e.T,t)};if(0==n.stock.length()&&1>=n.waste.length()){for(a=!1,i=0;7!=i;i++)if(s=n.tableausFaceDown[i],0<s.length()){a=!0;break}a||window.setTimeout(function(){for(var t=0;7!=t;t++){var o=n.tableausFaceUp[t];if(0<o.length()&&(p=o.length()-1,o=o.get(p),o=e.b[o]))for(k in o){var a=o[k];if(!a.e)return a.action(),K(n),void L(e,n)}}},400)}}function K(t){3<localStorage.gamePosition&&delete localStorage["gamePosition"+(localStorage.gamePosition-3)],localStorage.gamePosition++,localStorage["gamePosition"+localStorage.gamePosition]=JSON.stringify(t)}function R(){return 1<localStorage.gamePosition&&localStorage["gamePosition"+(localStorage.gamePosition-1)]}function V(){function t(t){t=t.toString();for(var n=0;n<t.length;n++){e+=t.charCodeAt(n);var o=.02519603282416938*e;e=o>>>0,o-=e,o*=e,e=o>>>0,o-=e,e+=4294967296*o}return 2.3283064365386963e-10*(e>>>0)}var e=4022871197;return t.version="Mash 0.9",t}function Q(){return function(t){function e(){var t=2091639*n+2.3283064365386963e-10*i;return n=o,o=a,a=t-(i=0|t)}var n=0,o=0,a=0,i=1;0==t.length&&(t=[+new Date]);for(var s=V(),n=s(" "),o=s(" "),a=s(" "),r=0;r<t.length;r++)n-=s(t[r]),0>n&&(n+=1),o-=s(t[r]),0>o&&(o+=1),a-=s(t[r]),0>a&&(a+=1);return s=null,e.ca=function(){return 4294967296*e()},e.ba=function(){return e()+1.1102230246251565e-16*(2097152*e()|0)},e.version="Alea 0.9",e.aa=t,e}(Array.prototype.slice.call(arguments))}p.prototype.add=function(t){this.cards.push(t)},p.prototype.get=function(t){return this.cards[t]},p.prototype.length=function(){return this.cards.length},p.prototype.pop=function(){return this.cards.pop()},p.prototype.indexOf=function(t){return this.cards.indexOf(t)},p.prototype.remove=function(t){return t=this.indexOf(t),-1==t?!1:(this.cards.splice(t,1),!0)},r.prototype.restore=function(t){if(!t.rules&&!t.rules.cardsToDraw)return!1;this.deck=new p(t.deck),this.stock=new p(t.stock),this.rules=t.rules,this.tableausFaceDown=[];for(var e=0;e!=t.tableausFaceDown.length;e++)this.tableausFaceDown.push(new p(t.tableausFaceDown[e]));for(this.tableausFaceUp=[],e=0;e!=t.tableausFaceUp.length;e++)this.tableausFaceUp.push(new p(t.tableausFaceUp[e]));for(this.waste=new p(t.waste),this.foundations=[],e=0;e!=t.foundations.length;e++)this.foundations.push(new p(t.foundations[e]));return!0},r.prototype.remove=function(t){for(var e=0;7!=e;e++){var n=this.tableausFaceUp[e];if(n.remove(t))return 0==n.length()&&(t=this.tableausFaceDown[e],0<t.length()&&(t=t.pop(),n.cards.splice(0,0,t))),!0}if(this.stock.remove(t)||this.waste.remove(t))return!0;for(n=0;4!=n;n++)if(this.foundations[n].remove(t))return!0;return!1};var O=new function(){function t(){window.setTimeout(t,1e3/this.u);var e=(new Date).getTime();for(k in o.d){var n=o.d[k],a=o.a[k],i=(e-n.startTime)/(n.U-n.startTime);i>1?(a.style.left=n.r+"px",a.style.top=n.s+"px",N(a,n),delete o.d[k]):(i=(Math.sin(i*(Math.PI/2-Math.PI/4)+Math.PI/4)-.5)/.5,a.style.left=i*(n.r-n.G)+n.G+"px",a.style.top=i*(n.s-n.H)+n.H+"px")}}this.t=document.getElementById("gameDiv"),this.g=103,this.f=143,this.i=this.h=this.m=42,this.k=210,this.j=115,this.n=25,this.w=386,this.A=115,this.l=this.h,this.N=109,this.K=149,this.O=1,this.P=716,this.L=-4,this.M=-3,this.R=196,this.S=22,this.T=this.h,this.v=4,this.I=0,this.Q=1,this.J=250,this.u=60,this.a=[],this.d={},this.o={},this.F=document.createElement("div"),this.t.appendChild(this.F),this.p=document.createElement("div"),this.t.appendChild(this.p),this.D=document.createElement("div"),this.t.appendChild(this.D);for(var e=0;52!=e;e++){var n=A(this);this.a[e]=n,this.p.appendChild(n)}var o=this;for(this.c=D(this),window.setTimeout(t,1e3/this.u),x(this,this.m,this.h),this.$=z(this,this.m,this.h),e=0;7!=e;e++)x(this,this.i+this.j*e,o.k);for(e=0;4!=e;e++)x(this,this.w+this.A*e,o.l)};window.redraw=function(){var e=P=new r,n=JSON.parse(localStorage.rules);for(e.deck=new p,e.stock=new p,e.tableausFaceDown=[],e.tableausFaceUp=[],e.waste=new p,e.foundations=[],e.rules=n,n=0;52!=n;n++)e.deck.add(n);var o,a,n=Q(localStorage.seed),i=e.deck.cards,s=i.length;if(s)for(;--s;)a=Math.floor(n()*(s+1)),o=i[a],i[a]=i[s],i[s]=o;for(n=0;7!=n;n++){for(e.tableausFaceDown[n]=new p,i=0;n-1>=i;i++)e.tableausFaceDown[n].add(e.deck.pop());e.tableausFaceUp[n]=new p,e.tableausFaceUp[n].add(e.deck.pop())}for(;0<e.deck.length();)e.stock.add(e.deck.pop());for(n=0;4!=n;n++)e.foundations[n]=new p;L(O,P),t(P),K(P),L(O,P)},window.newGame=function(t){localStorage.gamePosition=0,localStorage.version=2,localStorage.seed=Math.floor(1e5*Math.random()),localStorage.rules=JSON.stringify(t),window.redraw()},document.oncontextmenu=function(){return!1};var P;0<localStorage.gamePosition&&2==localStorage.version?(P=new r,P.restore(JSON.parse(localStorage["gamePosition"+localStorage.gamePosition]))?(L(O,P),L(O,P)):window.newGame({cardsToDraw:3})):window.newGame({cardsToDraw:3}),window.undo=function(){R()&&(localStorage.gamePosition--,P=new r,P.restore(JSON.parse(localStorage["gamePosition"+localStorage.gamePosition])),L(O,P))},window.applicationCache&&window.applicationCache.addEventListener("updateready",function(){window.applicationCache.status==window.applicationCache.UPDATEREADY&&window.applicationCache.swapCache()},!1),document.addEventListener("keypress",function(t){t.ctrlKey&&26===t.which&&window.undo()},!1);